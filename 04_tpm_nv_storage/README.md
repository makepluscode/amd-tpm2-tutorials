# 04_tpm_nv_storage: TPM NV RAM (í•˜ë“œì›¨ì–´ ë³´ì•ˆ ì €ì¥ì†Œ)

ì´ ì˜ˆì œëŠ” TPM(Trusted Platform Module) ë‚´ë¶€ì˜ ë¹„íœ˜ë°œì„± ë©”ëª¨ë¦¬(Non-Volatile RAM)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¼ê°í•œ ë°ì´í„°ë¥¼ í•˜ë“œì›¨ì–´ ë‚´ë¶€ì— ì§ì ‘ ì €ì¥í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì´ëŠ” ë°ì´í„°ê°€ ë””ìŠ¤í¬ë‚˜ íŒŒì¼ ì‹œìŠ¤í…œì— ì ˆëŒ€ ë‚¨ì§€ ì•Šê²Œ í•˜ëŠ” ê°€ì¥ ê°•ë ¥í•œ ë°ì´í„° ë³´í˜¸ ê¸°ë²•ì…ë‹ˆë‹¤.

## ğŸ›¡ï¸ ë³´ì•ˆ ê¸°ìˆ ì§€ì‹

### 1. NV RAM (Non-Volatile RAM)
TPM ë‚´ë¶€ì—ëŠ” ì „ì›ì´ êº¼ì ¸ë„ ë³´ì¡´ë˜ëŠ” ì‘ì€ í¬ê¸°ì˜ ë³´ì•ˆ ì €ì¥ ê³µê°„ì´ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ NV RAMì´ë¼ê³  í•˜ë©°, ì—¬ê¸°ì— ì €ì¥ëœ ë°ì´í„°ëŠ” TPM ì¹© ì™¸ë¶€ë¡œ ìœ ì¶œë˜ì§€ ì•Šë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### 2. NV Index
ë°ì´í„°ëŠ” 'Index'ë¼ëŠ” ì£¼ì†Œ ì²´ê³„ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ê° ì¸ë±ìŠ¤ëŠ” ê³ ìœ í•œ ê¶Œí•œ ì„¤ì •(Attributes)ì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©°, íŠ¹ì • ë¹„ë°€ë²ˆí˜¸ë‚˜ PCR(ì‹œìŠ¤í…œ ìƒíƒœ) ì¡°ê±´ì„ ë§Œì¡±í•´ì•¼ë§Œ ì½ê±°ë‚˜ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ë””ìŠ¤í¬ë¦¬ìŠ¤(Diskless) ë³´ì•ˆ
ì „í†µì ì¸ ì•”í˜¸í™” ê¸°ìˆ ì€ ì•”í˜¸í™”ëœ íŒŒì¼ì„ ë””ìŠ¤í¬ì— ë‚¨ê¸°ì§€ë§Œ, NV StorageëŠ” ë°ì´í„° ìì²´ê°€ ì¹© ì•ˆì— ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ìš´ì˜ì²´ì œê°€ ì™„ì „íˆ ì‚­ì œë˜ê±°ë‚˜ ë””ìŠ¤í¬ê°€ ë„ë‚œë‹¹í•´ë„ TPM ë‚´ë¶€ì˜ ë¹„ë°€ì€ ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…: 0x80280400 ì—ëŸ¬ í•´ê²°ë²•

`04_tpm_nv_storage.exe` ì‹¤í–‰ ì‹œ `TPM Error: 0x80280400`ì´ ë°œìƒí•œë‹¤ë©´, ì´ëŠ” Windowsì˜ **TPM ëª…ë ¹ ì°¨ë‹¨ ëª©ë¡ (Command Block List)** ë•Œë¬¸ì…ë‹ˆë‹¤. Windows ì‹œìŠ¤í…œ ë³´ì•ˆì„ ìœ„í•´ TBSë¥¼ í†µí•œ Raw NV ëª…ë ¹ ìˆ˜í–‰ì´ ê¸°ë³¸ì ìœ¼ë¡œ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ê°œë°œ ì‹¤ìŠµì„ ìœ„í•´ ì´ë¥¼ ì¼ì‹œì ìœ¼ë¡œ í•´ì œí•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¥´ì„¸ìš”.

> [!WARNING]
> ì´ ì„¤ì •ì€ ì‹œìŠ¤í…œ ë³´ì•ˆ ì •ì±…ì„ ì™„í™”í•˜ë¯€ë¡œ, ì‹¤ìŠµ í›„ì—ëŠ” ë°˜ë“œì‹œ ì›ë˜ëŒ€ë¡œ ëŒë ¤ë†“ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

1.  **íŒŒì›Œì‰˜(ê´€ë¦¬ì ê¶Œí•œ)**ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
2.  ë‹¤ìŒ ëª…ë ¹ì„ ì…ë ¥í•˜ì—¬ NV ê´€ë ¨ ì£¼ìš” ëª…ë ¹(Define, Write, Read, Undefine)ì˜ ì°¨ë‹¨ì„ í•´ì œí•©ë‹ˆë‹¤.
    ```powershell
    $path = "HKLM:\SOFTWARE\Microsoft\Tpm\CommandBlockList"
    # 12A: DefineSpace, 137: Write, 14E: Read, 122: UndefineSpace
    Set-ItemProperty -Path $path -Name "12A" -Value 0
    Set-ItemProperty -Path $path -Name "137" -Value 0
    Set-ItemProperty -Path $path -Name "14E" -Value 0
    Set-ItemProperty -Path $path -Name "122" -Value 0
    ```
3.  **ì¬ë¶€íŒ… ì—†ì´** í”„ë¡œê·¸ë¨ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥

- **TBS APIë¥¼ í†µí•œ ë¡œìš° ë ˆë²¨ ì œì–´**: Windows TBS(TPM Base Services)ë¥¼ ì‚¬ìš©í•˜ì—¬ raw TPM 2.0 ëª…ë ¹ì–´ë¥¼ ì§ì ‘ ì „ì†¡.
- **NV ì¸ë±ìŠ¤ ì •ì˜ (DefineSpace)**: í•˜ë“œì›¨ì–´ ë‚´ë¶€ì— íŠ¹ì • í¬ê¸°ì˜ ì €ì¥ ê³µê°„ ì˜ˆì•½.
- **ë°ì´í„° ì“°ê¸° (Write)**: TPM ì¹© ë‚´ë¶€ ë©”ëª¨ë¦¬ì— ì§ì ‘ ì“°ê¸°.
- **ë°ì´í„° ì½ê¸° (Read)**: ì €ì¥ëœ ë°ì´í„°ë¥¼ í•˜ë“œì›¨ì–´ë¡œë¶€í„° ì§ì ‘ ì¶”ì¶œ.
- **ì¸ë±ìŠ¤ ì œê±° (UndefineSpace)**: ì‚¬ìš©ì´ ëë‚œ ì €ì¥ ê³µê°„ì„ ì •ë¦¬(íŒŒì¼ ì‚­ì œì™€ ìœ ì‚¬).

## ë¹Œë“œ ë° ì‹¤í–‰

1. **ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° êµ¬ì„±**:
   ```powershell
   cmake -B build -S .
   ```

2. **ì»´íŒŒì¼**:
   ```powershell
   cmake --build build --config Release
   ```

3. **ì‹¤í–‰**:
   ```powershell
   .\build\Release\tpm_nv_storage.exe
   ```

## ì‹¤í–‰ ê²°ê³¼ (ì˜ˆì‹œ)

```text
[Example 04] TPM NV Storage (Hardware Secure Storage)
========================================================
[TPM] Defining NV Index 0x1500001 (Size: 64)...
[TPM] Writing data to NV Index 0x1500001...
âœ“ Successfully wrote secret to TPM NV RAM.
[TPM] Reading data from NV Index 0x1500001...
[TPM] Read Secret (20 bytes): 54 50 4d 5f 53 41 46 45 5f 53 45 43 52 45 54 5f 32 30 32 36
âœ“ Verification Success: Read data matches original secret!

[Cleanup] Do you want to delete the NV index? (For demo, deleting...)
[TPM] Undefining NV Index 0x1500001...
```
