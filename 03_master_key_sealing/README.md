# 03_master_key_sealing: λ§μ¤ν„° ν‚¤ μ‹¤λ§ (Key Wrapping/Sealing)

μ΄ μμ λ” TPM(Trusted Platform Module)μ„ μ‚¬μ©ν•μ—¬ λ―Όκ°ν• λ°μ΄ν„°(Master Key)λ¥Ό "μ‹¤λ§(Sealing)" λλ” "λν•‘(Wrapping)"ν•λ” λ°©λ²•μ„ λ³΄μ—¬μ¤λ‹λ‹¤. μ΄λ” μ¤‘μ” λ°μ΄ν„°λ¥Ό ν•λ“μ›¨μ–΄μ— κ²°μ†μ‹μΌ νΉμ • κΈ°κΈ° λ°–μΌλ΅λ” μ λ€ μ μ¶λμ§€ μ•κ² λ§λ“λ” κ°€μ¥ κΈ°λ³Έμ μΈ λ³΄μ• κΈ°λ²•μ…λ‹λ‹¤.

## π›΅οΈ λ³΄μ• κΈ°μ μ§€μ‹

### 1. λ΄‰ν¬ μ•”νΈν™” (Envelope Encryption)
λ°μ΄ν„°(ν‰λ¬Έ)λ¥Ό λ€μΉ­ ν‚¤(μ: AES)λ΅ μ•”νΈν™”ν•κ³ , κ·Έ λ€μΉ­ ν‚¤λ¥Ό λ‹¤μ‹ λΉ„λ€μΉ­ ν‚¤(μ: RSA)λ΅ μ•”νΈν™”ν•λ” λ°©μ‹μ„ λ§ν•©λ‹λ‹¤.
- λ³Έ μμ μ—μ„λ” λ€μΉ­ ν‚¤μΈ **λ§μ¤ν„° ν‚¤**λ¥Ό ν‰λ¬Έ λ°μ΄ν„°λ΅ κ°„μ£Όν•κ³ , μ΄λ¥Ό TPM λ‚΄λ¶€μ **RSA Storage Key**λ΅ μ•”νΈν™”(Sealing)ν•μ—¬ μ•μ „ν•κ² λ³΄κ΄€ν•©λ‹λ‹¤.

### 2. ν‚¤ λν•‘ (Key Wrapping) vs ν‚¤ μ‹¤λ§ (Key Sealing)
- **λν•‘(Wrapping)**: μ•”νΈν™” κΈ°μ μ„ μ‚¬μ©ν•μ—¬ ν‚¤ λ°μ΄ν„°λ¥Ό λ³΄νΈν•λ” μΌλ°μ μΈ μ©μ–΄μ…λ‹λ‹¤.
- **μ‹¤λ§(Sealing)**: TPM μ©μ–΄λ΅, λ°μ΄ν„°λ¥Ό λ‹¨μν μ•”νΈν™”ν•λ” κ²ƒλΏλ§ μ•„λ‹λΌ νΉμ • ν•λ“μ›¨μ–΄ μƒνƒ(PCR λ“±)μ— κ²°μ†(Bind)μ‹ν‚¤λ” κ²ƒκΉμ§€ ν¬ν•¨ν•  μ μμµλ‹λ‹¤. λ³Έ μμ μ—μ„λ” TPM ν•λ“μ›¨μ–΄ μ†μ κ¶ μ—†μ΄λ” ν’€ μ μ—†λ” "ν•λ“μ›¨μ–΄ λ°”μΈλ”©"μ— μ§‘μ¤‘ν•©λ‹λ‹¤.

### 3. TPM κ³„μΈµ κµ¬μ΅° (Storage Hierarchy)
TPMμ€ λ‚΄λ¶€μ— **Storage Root Key (SRK)**λΌλ” μµμƒμ„ ν‚¤λ¥Ό κ°€μ§‘λ‹λ‹¤. μ°λ¦¬κ°€ μƒμ„±ν• RSA Storage Keyλ” μ΄ SRK μ•„λμ— μ„μΉν•λ©°, ν•λ“μ›¨μ–΄ μ™Έλ¶€λ΅ μ μ¶λ  λ•λ” μ•”νΈν™”λ μƒνƒλ΅λ§ λ‚κ° μ μμµλ‹λ‹¤. λ”°λΌμ„ κ³µκ²©μκ°€ λ””μ¤ν¬μ λ¨λ“  λ°μ΄ν„°λ¥Ό λ³µμ ν•΄κ°€λ„ μ‹¤λ¬Ό TPM μΉ© μ—†μ΄λ” λ§μ¤ν„° ν‚¤λ¥Ό λ³µκµ¬ν•  μ μ—†μµλ‹λ‹¤.

## μ£Όμ” κΈ°λ¥

- **TPM κΈ°λ° RSA-2048 ν‚¤ μƒμ„±**: `MS_PLATFORM_CRYPTO_PROVIDER`λ¥Ό μ‚¬μ©ν•μ—¬ ν•λ“μ›¨μ–΄ λ‚΄λ¶€μ—λ§ μ΅΄μ¬ν•λ” λ³΄μ• ν‚¤ μƒμ„±.
- **ν•λ“μ›¨μ–΄ κΈ°λ° λ°μ΄ν„° λ΄‰μΈ (Encrypt)**: `NCryptEncrypt`λ¥Ό νΈμ¶ν•μ—¬ λ§μ¤ν„° ν‚¤λ¥Ό TPM ν‚¤λ΅ μ•”νΈν™”.
- **ν•λ“μ›¨μ–΄ κΈ°λ° λ°μ΄ν„° λ³µκµ¬ (Decrypt)**: `NCryptDecrypt`λ¥Ό νΈμ¶ν•μ—¬ μ‹¤λ¬Ό TPM ν•λ“μ›¨μ–΄λ¥Ό ν†µν•΄μ„λ§ ν‚¤ μ λ„.

## λΉλ“ λ° μ‹¤ν–‰

1. **λΉλ“ λ””λ ‰ν† λ¦¬ μƒμ„± λ° κµ¬μ„±**:
   ```powershell
   cmake -B build -S .
   ```

2. **μ»΄νμΌ**:
   ```powershell
   cmake --build build --config Release
   ```

3. **μ‹¤ν–‰**:
   ```powershell
   .\build\Release\master_key_sealing.exe
   ```

## μ‹¤ν–‰ κ²°κ³Ό (Actual Output)

```text
[Example 03] Master Key Sealing (Wrapping) with TPM
========================================================
[Master Key] Original (32 bytes): 62 2a 32 c3 08 3e f4 eb eb 02 89 9a 55 85 da cf 21 28 0c fd dd 8e 84 24 70 3d 77 35 5d 01 f6 35
[NCrypt] Using existing RSA Storage Key.
[NCrypt] Master Key successfully sealed.
[Storage] Sealed Blob (256 bytes): 04 0a 06 33 f0 27 63 00 9a 5b 1d a1 54 c2 40 f0 f3 2e d2 2b 90 b3 ac 3c 78 2a a5 6b 52 f6 2b 0c 04 a0 ...
[Master Key] Unsealed (32 bytes): 62 2a 32 c3 08 3e f4 eb eb 02 89 9a 55 85 da cf 21 28 0c fd dd 8e 84 24 70 3d 77 35 5d 01 f6 35
β“ Verification Success: Unsealed key matches original!
```

> [!IMPORTANT]
> **ν•λ“μ›¨μ–΄ λ…λ¦½μ„±**: μƒμ„±λ Sealed Blobμ€ μ•”νΈν™”λμ–΄ νμΌλ΅ μ €μ¥ν•  μ μμ§€λ§, μ΄λ¥Ό λ³µνΈν™”ν•  μ μλ” μ μΌν• μ—΄μ‡ (Storage Key)λ” μ¤μ§ ν•΄λ‹Ή PCμ TPM μ•μ—λ§ μ΅΄μ¬ν•©λ‹λ‹¤. λ”°λΌμ„ ν•λ“μ›¨μ–΄λ¥Ό λ¶„λ¦¬ν•μ—¬ λ‹¤λ¥Έ PCμ— μ—°κ²°ν•΄λ„ λ§μ¤ν„° ν‚¤λ¥Ό μ•μ•„λ‚Ό μ μ—†μµλ‹λ‹¤.
